% MATLAB Cyclic Command Publisher
% This script connects to an MQTT broker and cycles through sending the
% commands: WAIT, STOP, GO, and HALT to the robot with ID 780.

brokerAddress = "mqtt://rasticvm.lan";
robotID = "780";
topicPrefix = "limo"; % Base prefix for the Limo robot topics

% --- Command Topics ---
topicToPublish = "cmd/" + topicPrefix + robotID;
goaltoPublish = "goal/" + topicPrefix + robotID;

% --- Command and Goal Data Definitions ---
% List of commands to cycle through
allCommands = ["WAIT", "STOP", "GO", "HALT"];
commandIndex = 1; % Start with the first command: "WAIT"

% Goal message definition (JSON payload, required for 'GO' command)
% NOTE: The actual coordinates for a goal need to be defined here.
matlabStruct.goal = [1.0, 0.0]; % Example Goal: Go to X=1.0, Y=0.0
jsonGoalString = jsonencode(matlabStruct);

% --- Connection Setup ---
try 
    clear mqttClient
catch
end

try 
   % 1. Create client object
   mqttClient = mqttclient(brokerAddress, ClientId= 'AnveshPubCycler');
   disp(['Connected to MQTT Broker: ', brokerAddress])
   disp(['Control Topic: ', topicToPublish]);
   disp(['Goal Topic: ', goaltoPublish]);
   disp('------------------------------------------');
   
catch ME
    error('MQTT_SETUP:FailedConnect', 'Could not connect to the MQTT broker. Error: %s', ME.message);
end

% Execution Loop ---

disp('Starting command cycle (WAIT, STOP, GO, HALT)... Press Ctrl+C to stop.');

try
    while true
        % 1. Determine the current command
        currentCommand = allCommands(commandIndex);
        
        % 2. Publish the command message
        write(mqttClient, topicToPublish, currentCommand);
        
        % 3. Check if a Goal needs to be published (usually only for 'GO')
        if strcmp(currentCommand, "GO")
            write(mqttClient, goaltoPublish, jsonGoalString);
            disp(['GO and Goal (', currentCommand, ') | Payload: ', jsonGoalString]);
        else
            disp(['Command (', currentCommand, ')']);
        end

        % 4. Wait for 2 seconds
        pause(2)
        
        % 5. Advance to the next command in the cycle
        commandIndex = mod(commandIndex, length(allCommands)) + 1; 
    end
    
catch ME
    % Handle Ctrl+C or other errors cleanly
    if ~strcmp(ME.identifier, 'MATLAB:keyboard_interrupt')
        warning('ExecutionError', 'The execution loop terminated unexpectedly. Error: %s', ME.message);
    end
end

% --- Cleanup ---
if exist('mqttClient', 'var') && isvalid(mqttClient)
    clear mqttClient
    disp('------------------------------------------');
    disp('MQTT connection closed. Script terminated.');
end
